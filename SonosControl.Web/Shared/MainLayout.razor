@inherits LayoutComponentBase
@implements IDisposable
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Antiforgery
@using Microsoft.AspNetCore.Http
@using Microsoft.AspNetCore.Components.Routing
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.JSInterop
@using SonosControl.Web.Models
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject UserManager<ApplicationUser> UserManager
@inject SonosControl.Web.Services.ThemeService ThemeService
@inject IJSRuntime JSRuntime

<PageTitle>SonosControl.Web</PageTitle>

<div class="app-shell">
    <aside id="app-sidebar"
           class="app-sidebar @(_isDrawerOpen ? "is-open" : string.Empty)"
           tabindex="-1"
           @onkeydown="HandleSidebarKeyDown"
           @ref="_drawerRef">
        <NavMenu AntiforgeryToken="@AntiforgeryToken"
                 IsDrawerOpen="@_isDrawerOpen"
                 OnNavigate="HandleDrawerNavigationAsync" />
    </aside>

    @if (_isDrawerOpen)
    {
        <button type="button"
                class="app-drawer-backdrop"
                @onclick="CloseDrawerAsync"
                aria-label="Close navigation menu"></button>
    }

    <main class="app-main">
        <header class="app-mobile-top-bar d-lg-none">
            <div class="app-mobile-top-bar__content px-3">
                <button type="button"
                        class="app-mobile-menu-button"
                        aria-label="@(_isDrawerOpen ? "Close navigation menu" : "Open navigation menu")"
                        aria-controls="app-sidebar"
                        aria-expanded="@(_isDrawerOpen ? "true" : "false")"
                        @onclick="ToggleDrawerAsync">
                    <span class="oi @(_isDrawerOpen ? "oi-x" : "oi-menu")" aria-hidden="true"></span>
                </button>

                <div class="app-mobile-top-bar__identity">
                    <span class="app-mobile-top-bar__title">SonosControl</span>
                    <span class="app-mobile-top-bar__subtitle">Master every room</span>
                </div>

                <div class="app-mobile-top-bar__actions">
                    @if (isAuthenticated)
                    {
                        <a href="@($"/useredit")" class="top-link top-link--icon app-mobile-top-bar__profile-link" aria-label="Open profile settings">
                            <span class="oi oi-person" aria-hidden="true"></span>
                        </a>
                    }
                    else
                    {
                        <a href="/auth/login" class="top-link top-link--ghost app-mobile-top-bar__login-link">Login</a>
                    }
                </div>
            </div>
        </header>

        <header class="app-top-bar">
            <div class="app-top-bar__content px-4">
                <div class="app-top-bar__identity">
                    <span class="app-top-bar__title">SonosControl</span>
                    <span class="app-top-bar__subtitle">Master every room</span>
                </div>
                <div class="top-bar-actions">
                    @if (isAuthenticated)
                    {
                        <div class="theme-toggle">
                            <span class="text-uppercase text-muted small mb-0">Theme</span>
                            <div class="btn-group" role="group" aria-label="Theme preference">
                                @foreach (var mode in ThemeOptions)
                                {
                                    <button type="button"
                                            class="@GetThemeButtonClasses(mode)"
                                            aria-pressed="@(mode == _userThemePreference ? "true" : "false")"
                                            @onclick="() => ChangeThemeAsync(mode)">
                                        @GetThemeLabel(mode)
                                    </button>
                                }
                            </div>
                        </div>

                        <span class="top-bar-greeting">Hello, @firstName!</span>

                        <form method="post" action="/auth/logout" class="top-bar-logout">
                            <input type="hidden" name="__RequestVerificationToken" value="@AntiforgeryToken" />
                            <button type="submit" class="btn btn-sm btn-danger">Logout</button>
                        </form>

                        <a href="@($"/useredit")" class="top-link top-link--icon">
                            <span class="oi oi-person" aria-hidden="true"></span>
                        </a>
                    }
                    else
                    {
                        <a href="/auth/login" class="top-link top-link--ghost">Login</a>
                        <a href="/register" class="top-link top-link--primary">Register</a>
                    }
                </div>
            </div>
        </header>

        <section class="app-content-wrapper">
            <article class="content px-4">
                @Body
            </article>
        </section>
    </main>
</div>

@code {
    private string? firstName;
    private bool isAuthenticated;

    [CascadingParameter(Name = "AntiforgeryToken")]
    public string? AntiforgeryToken { get; set; }

    private ThemePreferenceMode _userThemePreference = ThemePreferenceMode.System;
    private static readonly ThemePreferenceMode[] ThemeOptions = new[]
    {
        ThemePreferenceMode.System,
        ThemePreferenceMode.Light,
        ThemePreferenceMode.Dark
    };
    private bool _hasAppliedThemeOnClient;
    private bool _themeSubscriptionRegistered;
    private bool _navigationSubscriptionRegistered;
    private bool _isDrawerOpen;
    private bool _isBodyScrollLocked;
    private bool _focusDrawerOnNextRender;
    private ElementReference _drawerRef;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        isAuthenticated = user.Identity?.IsAuthenticated ?? false;

        if (isAuthenticated)
        {
            var appUser = await UserManager.GetUserAsync(user);
            firstName = appUser?.FirstName ?? user.Identity?.Name;
        }

        await ThemeService.InitializeAsync();
        _userThemePreference = ThemeService.CurrentPreference;

        if (!_navigationSubscriptionRegistered)
        {
            Navigation.LocationChanged += HandleLocationChanged;
            _navigationSubscriptionRegistered = true;
        }
    }

    private async Task ToggleDrawerAsync()
    {
        await SetDrawerStateAsync(!_isDrawerOpen, focusDrawer: !_isDrawerOpen);
    }

    private async Task CloseDrawerAsync()
    {
        await SetDrawerStateAsync(false);
    }

    private async Task HandleDrawerNavigationAsync()
    {
        await CloseDrawerAsync();
    }

    private async Task SetDrawerStateAsync(bool isOpen, bool focusDrawer = false)
    {
        if (_isDrawerOpen == isOpen)
        {
            return;
        }

        _isDrawerOpen = isOpen;
        _focusDrawerOnNextRender = isOpen && focusDrawer;
        await UpdateBodyScrollLockAsync(isOpen);
        await InvokeAsync(StateHasChanged);
    }

    private async Task UpdateBodyScrollLockAsync(bool lockBody)
    {
        if (_isBodyScrollLocked == lockBody)
        {
            return;
        }

        try
        {
            await JSRuntime.InvokeVoidAsync("window.sonosUi.setBodyScrollLock", lockBody);
            _isBodyScrollLocked = lockBody;
        }
        catch (JSException)
        {
            // Ignore when interop is not available during prerender.
        }
    }

    private Task HandleSidebarKeyDown(KeyboardEventArgs args)
    {
        if (args.Key == "Escape")
        {
            return CloseDrawerAsync();
        }

        return Task.CompletedTask;
    }

    private void HandleLocationChanged(object? sender, LocationChangedEventArgs args)
    {
        if (_isDrawerOpen)
        {
            _ = InvokeAsync(CloseDrawerAsync);
        }
    }

    private async Task ChangeThemeAsync(ThemePreferenceMode mode)
    {
        if (!isAuthenticated || _userThemePreference == mode)
        {
            return;
        }

        _userThemePreference = mode;
        await ThemeService.SetPreferenceAsync(mode);
    }

    private static string GetThemeLabel(ThemePreferenceMode mode) => mode switch
    {
        ThemePreferenceMode.Light => "Light",
        ThemePreferenceMode.Dark => "Dark",
        _ => "System"
    };

    private string GetThemeButtonClasses(ThemePreferenceMode mode)
        => mode == _userThemePreference ? "btn btn-sm btn-primary" : "btn btn-sm btn-outline-light";

    private async Task ApplyThemePreferenceAsync()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("window.sonosTheme.apply", ThemeService.CurrentPreferenceIdentifier);
        }
        catch (JSException)
        {
            // The inline script might not be available yet; swallow so the layout still renders.
        }
    }

    private void OnThemePreferenceChanged()
    {
        _ = InvokeAsync(async () =>
        {
            _userThemePreference = ThemeService.CurrentPreference;
            await ApplyThemePreferenceAsync();
            _hasAppliedThemeOnClient = true;
            StateHasChanged();
        });
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!_themeSubscriptionRegistered)
        {
            ThemeService.OnPreferenceChanged += OnThemePreferenceChanged;
            _themeSubscriptionRegistered = true;
        }

        if (!_hasAppliedThemeOnClient)
        {
            await ApplyThemePreferenceAsync();
            _hasAppliedThemeOnClient = true;
        }

        if (_focusDrawerOnNextRender)
        {
            _focusDrawerOnNextRender = false;
            try
            {
                await _drawerRef.FocusAsync();
            }
            catch (InvalidOperationException)
            {
                // Ignore if sidebar is not focusable yet.
            }
        }
    }

    [Inject] private NavigationManager Navigation { get; set; } = default!;

    void IDisposable.Dispose()
    {
        if (_navigationSubscriptionRegistered)
        {
            Navigation.LocationChanged -= HandleLocationChanged;
        }

        if (_themeSubscriptionRegistered)
        {
            ThemeService.OnPreferenceChanged -= OnThemePreferenceChanged;
        }

        if (_isBodyScrollLocked)
        {
            _ = JSRuntime.InvokeVoidAsync("window.sonosUi.setBodyScrollLock", false);
            _isBodyScrollLocked = false;
        }
    }
}
