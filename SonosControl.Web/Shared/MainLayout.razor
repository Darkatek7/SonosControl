@inherits LayoutComponentBase
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Antiforgery
@using Microsoft.AspNetCore.Http
@using SonosControl.Web.Models
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject UserManager<ApplicationUser> UserManager
@inject IAntiforgery Antiforgery
@inject IHttpContextAccessor HttpContextAccessor

<PageTitle>SonosControl.Web</PageTitle>

<div class="app-shell">
    <aside class="app-sidebar">
        <NavMenu />
    </aside>

    <main class="app-main">
        <header class="app-top-bar">
            <div class="app-top-bar__content px-4">
                <div class="app-top-bar__identity">
                    <span class="app-top-bar__title">SonosControl</span>
                    <span class="app-top-bar__subtitle">Master every room</span>
                </div>
                <div class="top-bar-actions">
                    @if (!isAuthenticated)
                    {
                        <a href="/auth/login" class="top-link top-link--ghost">Login</a>
                        <a href="/register" class="top-link top-link--primary">Register</a>
                    }
                    else
                    {
                        <span class="top-bar-greeting">Hello, @firstName!</span>

                        <form method="post" action="/auth/logout" class="top-bar-logout">
                            <input type="hidden" name="__RequestVerificationToken" value="@antiforgeryToken" />
                            <button type="submit" class="btn btn-sm btn-danger">Logout</button>
                        </form>

                        <a href="@($"/useredit")" class="top-link top-link--icon">
                            <span class="oi oi-person" aria-hidden="true"></span>
                        </a>
                    }
                </div>
            </div>
        </header>

        <section class="app-content-wrapper">
            <article class="content px-4">
                @Body
            </article>
        </section>
    </main>
</div>

@code {
    private string? firstName;
    private bool isAuthenticated;
    private string? userId;
    private string? antiforgeryToken;

    protected override async Task OnInitializedAsync()
    {
        antiforgeryToken = Antiforgery.GetAndStoreTokens(HttpContextAccessor.HttpContext!).RequestToken;

        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        isAuthenticated = user.Identity?.IsAuthenticated ?? false;

        if (isAuthenticated)
        {
            var appUser = await UserManager.GetUserAsync(user);
            firstName = appUser?.FirstName ?? user.Identity?.Name;
            userId = appUser?.Id;
        }
    }

    private async Task Logout(MouseEventArgs e)
    {
        var http = new HttpClient { BaseAddress = new Uri(Navigation.BaseUri) };
        var request = new HttpRequestMessage(HttpMethod.Post, "auth/logout");
        request.Headers.Add("RequestVerificationToken", antiforgeryToken);
        var response = await http.SendAsync(request);
        if (response.IsSuccessStatusCode)
        {
            Navigation.NavigateTo("/");
        }
    }
    [Inject] private NavigationManager Navigation { get; set; } = default!;
}

