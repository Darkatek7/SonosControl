@implements IDisposable
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Antiforgery
@using Microsoft.AspNetCore.Http
@using Microsoft.JSInterop
@using SonosControl.Web.Models
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject SonosControl.Web.Services.ThemeService ThemeService
@inject IJSRuntime JSRuntime

<div class="nav-shell">
    <div class="nav-brand-row px-3">
        <div class="nav-brand-mark">SC</div>
        <div class="nav-brand-text">
            <span class="nav-brand-title">SonosControl</span>
            <span class="nav-brand-subtitle">Command center</span>
        </div>
        <button type="button"
                class="nav-drawer-close d-lg-none"
                title="Close navigation menu"
                aria-label="Close navigation menu"
                @onclick="HandleNavigate">
            <span class="oi oi-x" aria-hidden="true"></span>
        </button>
    </div>

    <div class="nav-scrollable px-3" data-drawer-open="@(IsDrawerOpen ? "true" : "false")">
        <nav class="nav-links">
            <div class="nav-item">
                <NavLink class="nav-link" href="" Match="NavLinkMatch.All" @onclick="HandleNavigate">
                    <span class="nav-icon oi oi-home" aria-hidden="true"></span>
                    <span>Home</span>
                </NavLink>
            </div>
            <div class="nav-item">
                <NavLink class="nav-link" href="lookup" @onclick="HandleNavigate">
                    <span class="nav-icon oi oi-magnifying-glass" aria-hidden="true"></span>
                    <span>Station Lookup</span>
                </NavLink>
            </div>

            <AuthorizeView Roles="admin,operator,superadmin">
                <Authorized>
                    <div class="nav-item">
                        <NavLink class="nav-link" href="stats" @onclick="HandleNavigate">
                            <span class="nav-icon oi oi-graph" aria-hidden="true"></span>
                            <span>Statistics</span>
                        </NavLink>
                    </div>
                    <div class="nav-item">
                        <NavLink class="nav-link" href="scenes" @onclick="HandleNavigate">
                            <span class="nav-icon oi oi-layers" aria-hidden="true"></span>
                            <span>Scenes</span>
                        </NavLink>
                    </div>
                    <div class="nav-item">
                        <NavLink class="nav-link" href="recommendations" @onclick="HandleNavigate">
                            <span class="nav-icon oi oi-star" aria-hidden="true"></span>
                            <span>Recommendations</span>
                        </NavLink>
                    </div>
                </Authorized>
            </AuthorizeView>

            <AuthorizeView Roles="admin,superadmin">
                <Authorized>
                    <div class="nav-divider" aria-hidden="true"></div>
                    <div class="nav-item">
                        <NavLink class="nav-link" href="schedule-windows" @onclick="HandleNavigate">
                            <span class="nav-icon oi oi-calendar" aria-hidden="true"></span>
                            <span>Schedule Windows</span>
                        </NavLink>
                    </div>
                    <div class="nav-item">
                        <NavLink class="nav-link" href="devices" @onclick="HandleNavigate">
                            <span class="nav-icon oi oi-rss" aria-hidden="true"></span>
                            <span>Device Ops</span>
                        </NavLink>
                    </div>
                    <div class="nav-item">
                        <NavLink class="nav-link" href="config" @onclick="HandleNavigate">
                            <span class="nav-icon oi oi-cog" aria-hidden="true"></span>
                            <span>Sonos Config</span>
                        </NavLink>
                    </div>
                    <div class="nav-item">
                        <NavLink class="nav-link" href="admin/users" @onclick="HandleNavigate">
                            <span class="nav-icon oi oi-person" aria-hidden="true"></span>
                            <span>User Management</span>
                        </NavLink>
                    </div>
                    <div class="nav-item">
                        <NavLink class="nav-link" href="logs" @onclick="HandleNavigate">
                            <span class="nav-icon oi oi-file" aria-hidden="true"></span>
                            <span>Logs</span>
                        </NavLink>
                    </div>
                    <div class="nav-item">
                        <NavLink class="nav-link" href="settings-backups" @onclick="HandleNavigate">
                            <span class="nav-icon oi oi-hard-drive" aria-hidden="true"></span>
                            <span>Backups</span>
                        </NavLink>
                    </div>
                </Authorized>
            </AuthorizeView>
        </nav>

    </div>

    <div class="d-lg-none mt-auto px-3 pb-3 border-top pt-3">
        <AuthorizeView>
            <Authorized>
                <div class="mb-4 px-1">
                    <span class="text-muted small text-uppercase d-block mb-2 fw-bold nav-theme-label">Theme</span>
                    <div class="btn-group w-100 shadow-sm" role="group" aria-label="Theme preference">
                        @foreach (var mode in ThemeOptions)
                        {
                            <button type="button"
                                    class="@GetThemeButtonClasses(mode) flex-grow-1"
                                    aria-pressed="@(mode == _userThemePreference ? "true" : "false")"
                                    @onclick="() => ChangeThemeAsync(mode)">
                                @GetThemeLabel(mode)
                            </button>
                        }
                    </div>
                </div>

                <div class="px-1 d-flex flex-column gap-2">
                    <div class="d-flex align-items-center gap-2 mb-2 px-1">
                            <div class="d-flex align-items-center justify-content-center bg-light rounded-circle nav-user-avatar">
                            <span class="oi oi-person text-secondary nav-user-icon"></span>
                            </div>
                            <div class="d-flex flex-column nav-user-meta">
                            <span class="fw-bold small">Signed in as</span>
                            <span class="text-truncate nav-user-name">@context.User.Identity?.Name</span>
                            </div>
                    </div>

                    <a href="/useredit"
                       class="btn btn-outline-secondary w-100 d-flex align-items-center justify-content-center gap-2"
                       @onclick="HandleNavigate">
                        <span class="oi oi-cog" aria-hidden="true"></span> <span>Profile Settings</span>
                    </a>

                    <form method="post" action="/auth/logout" class="w-100 m-0" @onsubmit="HandleNavigate">
                        <input type="hidden" name="__RequestVerificationToken" value="@AntiforgeryToken" />
                        <button type="submit" class="btn btn-danger w-100 d-flex align-items-center justify-content-center gap-2">
                                <span class="oi oi-account-logout" aria-hidden="true"></span> <span>Log Out</span>
                        </button>
                    </form>
                </div>
            </Authorized>
            <NotAuthorized>
                <div class="d-flex flex-column gap-2 px-1">
                    <a href="/auth/login" class="btn btn-outline-primary w-100" @onclick="HandleNavigate">Log In</a>
                    <a href="/register" class="btn btn-primary w-100" @onclick="HandleNavigate">Register</a>
                </div>
            </NotAuthorized>
        </AuthorizeView>
    </div>

    <div class="nav-footer px-3">
        <span class="nav-footer-note">Syncing rooms in real time.</span>
    </div>
</div>

@code {
    [Parameter]
    public string? AntiforgeryToken { get; set; }

    [Parameter]
    public bool IsDrawerOpen { get; set; }

    [Parameter]
    public EventCallback OnNavigate { get; set; }

    private bool isAuthenticated;

    private ThemePreferenceMode _userThemePreference = ThemePreferenceMode.System;
    private static readonly ThemePreferenceMode[] ThemeOptions = new[]
    {
        ThemePreferenceMode.System,
        ThemePreferenceMode.Light,
        ThemePreferenceMode.Dark
    };
    private bool _themeSubscriptionRegistered;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        isAuthenticated = user.Identity?.IsAuthenticated ?? false;

        _userThemePreference = ThemeService.CurrentPreference;
    }

    private async Task ChangeThemeAsync(ThemePreferenceMode mode)
    {
        if (!isAuthenticated || _userThemePreference == mode)
        {
            return;
        }

        _userThemePreference = mode;
        await ThemeService.SetPreferenceAsync(mode);
    }

    private static string GetThemeLabel(ThemePreferenceMode mode) => mode switch
    {
        ThemePreferenceMode.Light => "Light",
        ThemePreferenceMode.Dark => "Dark",
        _ => "System"
    };

    private string GetThemeButtonClasses(ThemePreferenceMode mode)
        => mode == _userThemePreference ? "btn btn-sm btn-primary" : "btn btn-sm btn-outline-secondary";

    private Task HandleNavigate()
    {
        return OnNavigate.InvokeAsync();
    }

    private async Task ApplyThemePreferenceAsync()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("window.sonosTheme.apply", ThemeService.CurrentPreferenceIdentifier);
        }
        catch (JSException)
        {
            // Ignore
        }
    }

    private void OnThemePreferenceChanged()
    {
        _ = InvokeAsync(async () =>
        {
            _userThemePreference = ThemeService.CurrentPreference;
            await ApplyThemePreferenceAsync();
            StateHasChanged();
        });
    }

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            if (!_themeSubscriptionRegistered)
            {
                ThemeService.OnPreferenceChanged += OnThemePreferenceChanged;
                _themeSubscriptionRegistered = true;
            }
        }
    }

    void IDisposable.Dispose()
    {
        if (_themeSubscriptionRegistered)
        {
            ThemeService.OnPreferenceChanged -= OnThemePreferenceChanged;
        }
    }
}
