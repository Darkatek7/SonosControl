@page "/admin/users"
@using Microsoft.AspNetCore.Identity
@using SonosControl.Web.Models
@inject UserManager<ApplicationUser> UserManager
@inject RoleManager<IdentityRole> RoleManager
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@using SonosControl.Web.Data
@inject ApplicationDbContext Db
@inject IJSRuntime JS
@inject IUnitOfWork _uow
@attribute [Authorize(Roles = "admin,operator,superadmin")]

<PageTitle>User Management</PageTitle>

<div class="user-management-shell">
    <section class="panel user-management-panel stack-lg" aria-labelledby="user-management-heading">
        <header class="user-management__header">
            <div>
                <h3 id="user-management-heading" class="page-title mb-1">👥 User Management</h3>
                <p class="text-muted small mb-0">Manage accounts, roles, and activation states securely.</p>
            </div>
            @if (isAdmin)
            {
                <div class="user-management__header-control">
                    <FormField Label="Allow user registration"
                               Id="@RegistrationSwitchId"
                               HelperText="@RegistrationSwitchHelperText">
                        <div class="form-check form-switch m-0">
                            <input class="form-check-input user-management__switch"
                                   type="checkbox"
                                   role="switch"
                                   id="@RegistrationSwitchId"
                                   checked="@allowUserRegistration"
                                   @onchange="ToggleRegistration"
                                   aria-label="Allow user registration toggle" />
                        </div>
                    </FormField>
                </div>
            }
        </header>

        <div class="user-management__body stack-md">
            @if (isLoading)
            {
                <p class="text-muted mb-0">Loading users...</p>
            }
            else
            {
                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <FormStatus StatusMessage="@errorMessage" Severity="FormStatus.AlertSeverity.Danger" />
                }

                <div class="table-responsive user-management__table-wrapper">
                    <table class="table user-management-table mb-0">
                        <thead>
                        <tr>
                            <th scope="col">User</th>
                            <th scope="col" class="d-none d-xl-table-cell">First</th>
                            <th scope="col" class="d-none d-xl-table-cell">Last</th>
                            <th scope="col" class="d-none d-md-table-cell">Email</th>
                            <th scope="col" class="d-none d-lg-table-cell">Roles</th>
                            <th scope="col" class="text-center">Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        @foreach (var user in users)
                        {
                            <tr>
                                <td>@user.UserName</td>

                                <td class="d-none d-xl-table-cell">@user.FirstName</td>
                                <td class="d-none d-xl-table-cell">@user.LastName</td>

                                <td class="d-none d-md-table-cell">@user.Email</td>

                                <td class="d-none d-lg-table-cell user-management__roles">
                                    @foreach (var role in userRoles[user.Id])
                                    {
                                        <span class="badge user-role-badge">@role</span>
                                    }
                                </td>

                                <td class="text-center">
                                    <div class="user-actions">
                                        <button type="button"
                                                class="btn btn-outline-danger user-action-btn"
                                                @onclick="() => DeleteUser(user)"
                                                disabled="@(IsCurrentUser(user) || (!isSuperAdmin && userRoles[user.Id].Contains("superadmin")))"
                                                aria-label="Delete user">
                                            Delete
                                        </button>

                                        @if (isSuperAdmin)
                                        {
                                            <button type="button"
                                                    class="btn btn-outline-primary user-action-btn"
                                                    @onclick='() => ToggleRole(user, "admin")'
                                                    disabled="@IsCurrentUser(user)">
                                                @(userRoles[user.Id].Contains("admin") ? "−Admin" : "+Admin")
                                            </button>

                                            <button type="button"
                                                    class="btn btn-outline-secondary user-action-btn"
                                                    @onclick='() => ToggleRole(user, "operator")'
                                                    disabled="@IsCurrentUser(user)">
                                                @(userRoles[user.Id].Contains("operator") ? "−Operator" : "+Operator")
                                            </button>

                                            <button type="button"
                                                    class="btn btn-outline-warning user-action-btn"
                                                    @onclick='() => ToggleRole(user, "superadmin")'
                                                    disabled="@IsCurrentUser(user)">
                                                @(userRoles[user.Id].Contains("superadmin") ? "−Superuser" : "+Superuser")
                                            </button>
                                        }

                                        <button type="button"
                                                class="btn user-action-btn @GetActivationButtonClass(user)"
                                                @onclick='() => ToggleUserActivation(user)'
                                                disabled="@IsCurrentUser(user)"
                                                aria-label="Toggle user activation status">
                                            @(IsUserActive(user) ? "✔" : "⛔")
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                        </tbody>
                    </table>
                </div>

                <div class="user-management__legend">
                    <strong>Legend:</strong>
                    <span class="ms-3">✔ = Active</span>
                    <span class="ms-3">⛔ = Deactivated</span>
                </div>
            }
        </div>
    </section>
</div>

@code {
    private List<ApplicationUser> users = new();
    private Dictionary<string, IList<string>> userRoles = new();
    private bool isLoading = true;
    private string? errorMessage;
    private string? currentUserName;
    private bool isSuperAdmin;
    private bool isAdmin;
    private bool allowUserRegistration;
    private SonosSettings? _settings;
    private readonly string RegistrationSwitchId = $"allowRegistrationSwitch_{System.Guid.NewGuid():N}";

    private string RegistrationSwitchHelperText => allowUserRegistration ? "Open to new users." : "Closed to new signups.";

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        currentUserName = authState.User.Identity?.Name;
        isSuperAdmin = authState.User.IsInRole("superadmin");
        isAdmin = isSuperAdmin || authState.User.IsInRole("admin");

        try
        {
            users = UserManager.Users
                .OrderBy(u => u.UserName)
                .ToList();

            foreach (var user in users)
            {
                var roles = await UserManager.GetRolesAsync(user);
                userRoles[user.Id] = roles;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading users: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }

        _settings = await _uow.ISettingsRepo.GetSettings();
        allowUserRegistration = _settings?.AllowUserRegistration ?? true;
    }

    private async Task ToggleRegistration(ChangeEventArgs e)
    {
        allowUserRegistration = e.Value is bool b && b;
        if (_settings is not null)
        {
            _settings.AllowUserRegistration = allowUserRegistration;
            await _uow.ISettingsRepo.WriteSettings(_settings);
            await AddLog(allowUserRegistration ? "Registration enabled" : "Registration disabled");
        }
    }

    private async Task DeleteUser(ApplicationUser user)
    {
        if (IsCurrentUser(user))
        {
            errorMessage = "You cannot delete your own user account.";
            return;
        }

        if (userRoles[user.Id].Contains("superadmin") && !isSuperAdmin)
        {
            errorMessage = "You cannot delete a super administrator.";
            return;
        }

        var confirmed = await JS.InvokeAsync<bool>("confirm", $"Are you sure you want to delete user '{user.UserName}'?");
        if (!confirmed) return;

        var result = await UserManager.DeleteAsync(user);
        if (result.Succeeded)
        {
            users.Remove(user);
            userRoles.Remove(user.Id);
            errorMessage = null;
            StateHasChanged();
            AddLog("User deleted", $"user: {user.UserName}, {user.FirstName}, {user.LastName}, {user.Email}");
        }
        else
        {
            errorMessage = $"Failed to delete user: {string.Join(", ", result.Errors.Select(e => e.Description))}";
        }
    }

    private bool IsUserActive(ApplicationUser user)
    {
        // If LockoutEnabled is false, user is active.
        // Or if LockoutEnd is in the past or null, user is active.
        if (!user.LockoutEnabled)
            return true;

        if (user.LockoutEnd == null)
            return true;

        return user.LockoutEnd <= DateTimeOffset.UtcNow;
    }

    private async Task ToggleUserActivation(ApplicationUser user)
    {
        if (IsCurrentUser(user))
        {
            errorMessage = "You cannot deactivate/reactivate your own user account.";
            return;
        }

        if (IsUserActive(user))
        {
            // Deactivate user: enable lockout and set LockoutEnd far in the future
            user.LockoutEnabled = true;
            user.LockoutEnd = DateTimeOffset.MaxValue;
            await AddLog("User deactivated", $"user: {user.UserName}, {user.FirstName}, {user.LastName}, {user.Email}");
        }
        else
        {
            // Reactivate user: disable lockout and clear LockoutEnd
            user.LockoutEnd = null;
            user.LockoutEnabled = false;
            await AddLog("User activated", $"user: {user.UserName}, {user.FirstName}, {user.LastName}, {user.Email}");
        }

        var result = await UserManager.UpdateAsync(user);

        if (result.Succeeded)
        {
            errorMessage = null;
            // Update the local user list to reflect changes
            var index = users.FindIndex(u => u.Id == user.Id);
            if (index >= 0)
                users[index] = user;

            StateHasChanged();
        }
        else
        {
            errorMessage = $"Failed to update user activation status: {string.Join(", ", result.Errors.Select(e => e.Description))}";
        }
    }

    private string GetActivationButtonClass(ApplicationUser user) =>
        IsUserActive(user) ? "btn-outline-success" : "btn-outline-warning";

    private async Task ToggleRole(ApplicationUser user, string role)
    {
        if (!isSuperAdmin)
        {
            errorMessage = "Only super administrators can modify roles.";
            return;
        }

        if (IsCurrentUser(user))
        {
            errorMessage = "You cannot modify your own roles.";
            return;
        }

        if (!await RoleManager.RoleExistsAsync(role))
        {
            errorMessage = $"Role '{role}' does not exist.";
            return;
        }

        if (userRoles[user.Id].Contains(role))
        {
            var removeResult = await UserManager.RemoveFromRoleAsync(user, role);
            if (removeResult.Succeeded)
            {
                userRoles[user.Id] = await UserManager.GetRolesAsync(user);
                errorMessage = null;
            }
            else
            {
                errorMessage = $"Failed to remove role '{role}': {string.Join(", ", removeResult.Errors.Select(e => e.Description))}";
            }
        }
        else
        {
            var addResult = await UserManager.AddToRoleAsync(user, role);
            if (addResult.Succeeded)
            {
                userRoles[user.Id] = await UserManager.GetRolesAsync(user);
                errorMessage = null;
            }
            else
            {
                errorMessage = $"Failed to add role '{role}': {string.Join(", ", addResult.Errors.Select(e => e.Description))}";
            }
        }

        StateHasChanged();
    }

    private bool IsCurrentUser(ApplicationUser user)
    {
        return string.Equals(user.UserName, currentUserName, StringComparison.OrdinalIgnoreCase);
    }

    private async Task AddLog(string action, string? details = null)
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        var username = user.Identity?.Name ?? "Unknown";

        var log = new LogEntry
        {
            Action = action,
            PerformedBy = username,
            Timestamp = DateTime.UtcNow,
            Details = details
        };

        Db.Logs.Add(log);
        await Db.SaveChangesAsync();
    }

}


