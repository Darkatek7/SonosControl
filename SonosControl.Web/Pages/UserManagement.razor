@page "/admin/users"
@using Microsoft.AspNetCore.Identity
@using SonosControl.Web.Models
@inject UserManager<ApplicationUser> UserManager
@inject RoleManager<IdentityRole> RoleManager
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@using SonosControl.Web.Data
@inject ApplicationDbContext Db
@inject IUnitOfWork _uow
@inject DialogService DialogService
@inject NotificationService NotificationService
@attribute [Authorize(Roles = "admin,operator,superadmin")]

<PageTitle>User Management</PageTitle>

<div class="user-management-shell">
    <section class="panel user-management-panel stack-lg" aria-labelledby="user-management-heading">
        <header class="user-management__header">
            <div>
                <h3 id="user-management-heading" class="page-title mb-1">ðŸ‘¥ User Management</h3>
                <p class="text-muted small mb-0">Manage accounts, roles, and activation states securely.</p>
            </div>
            @if (isAdmin)
            {
                <div class="user-management__header-control">
                    <FormField Label="Allow user registration"
                               Id="@RegistrationSwitchId"
                               HelperText="@RegistrationSwitchHelperText">
                        <div class="form-check form-switch m-0">
                            <input class="form-check-input user-management__switch"
                                   type="checkbox"
                                   role="switch"
                                   id="@RegistrationSwitchId"
                                   checked="@allowUserRegistration"
                                   @onchange="ToggleRegistration"
                                   aria-label="Allow user registration toggle" />
                        </div>
                    </FormField>
                </div>
            }
        </header>

        <div class="user-management__body stack-md">
            @if (isLoading)
            {
                <RadzenProgressBar Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
            }
            else
            {
                 <RadzenDataGrid AllowFiltering="true" AllowColumnResize="true" AllowAlternatingRows="false" FilterMode="FilterMode.Advanced" AllowSorting="true" PageSize="10" AllowPaging="true" PagerHorizontalAlign="HorizontalAlign.Left" ShowPagingSummary="true"
                    Data="@users" TItem="ApplicationUser" ColumnWidth="300px" LogicalFilterOperator="LogicalFilterOperator.Or">
                    <Columns>
                        <RadzenDataGridColumn TItem="ApplicationUser" Property="UserName" Title="User" Width="150px" />
                        <RadzenDataGridColumn TItem="ApplicationUser" Property="FirstName" Title="First Name" />
                        <RadzenDataGridColumn TItem="ApplicationUser" Property="LastName" Title="Last Name" />
                        <RadzenDataGridColumn TItem="ApplicationUser" Property="Email" Title="Email" />
                        <RadzenDataGridColumn TItem="ApplicationUser" Title="Roles" Sortable="false" Filterable="false">
                            <Template Context="user">
                                @foreach (var role in userRoles[user.Id])
                                {
                                    <RadzenBadge BadgeStyle="BadgeStyle.Info" Text="@role" Class="me-1" />
                                }
                            </Template>
                        </RadzenDataGridColumn>
                         <RadzenDataGridColumn TItem="ApplicationUser" Title="Status" Sortable="false" Filterable="false" Width="100px">
                            <Template Context="user">
                                @if(IsUserActive(user))
                                {
                                     <RadzenBadge BadgeStyle="BadgeStyle.Success" Text="Active" />
                                }
                                else
                                {
                                     <RadzenBadge BadgeStyle="BadgeStyle.Danger" Text="Inactive" />
                                }
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="ApplicationUser" Title="Actions" Sortable="false" Filterable="false" TextAlign="TextAlign.Center" Width="120px">
                            <Template Context="user">
                                <RadzenSplitButton Click="@((args) => OnActionClick(args, user))" Icon="settings" Style="height: 30px; padding: 0 10px;" Text="Actions" Variant="Variant.Flat" ButtonStyle="ButtonStyle.Light" Size="ButtonSize.Small">
                                    <ChildContent>
                                        <RadzenSplitButtonItem Text="Edit" Value="edit" Icon="edit" Disabled="@(IsCurrentUser(user) || (!isSuperAdmin && userRoles[user.Id].Contains("superadmin")))" />
                                        <RadzenSplitButtonItem Text="Delete" Value="delete" Icon="delete"  Disabled="@(IsCurrentUser(user) || (!isSuperAdmin && userRoles[user.Id].Contains("superadmin")))" />
                                    </ChildContent>
                                </RadzenSplitButton>
                            </Template>
                        </RadzenDataGridColumn>
                    </Columns>
                </RadzenDataGrid>
            }
        </div>
    </section>
</div>

@code {
    private List<ApplicationUser> users = new();
    private Dictionary<string, IList<string>> userRoles = new();
    private bool isLoading = true;
    private string? currentUserName;
    private bool isSuperAdmin;
    private bool isAdmin;
    private bool allowUserRegistration;
    private SonosSettings? _settings;
    private readonly string RegistrationSwitchId = $"allowRegistrationSwitch_{System.Guid.NewGuid():N}";

    private string RegistrationSwitchHelperText => allowUserRegistration ? "Open to new users." : "Closed to new signups.";

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        currentUserName = authState.User.Identity?.Name;
        isSuperAdmin = authState.User.IsInRole("superadmin");
        isAdmin = isSuperAdmin || authState.User.IsInRole("admin");

        await LoadUsers();

        _settings = await _uow.ISettingsRepo.GetSettings();
        allowUserRegistration = _settings?.AllowUserRegistration ?? true;
    }

    private async Task LoadUsers()
    {
        isLoading = true;
        try
        {
            users = UserManager.Users
                .OrderBy(u => u.UserName)
                .ToList();

            foreach (var user in users)
            {
                var roles = await UserManager.GetRolesAsync(user);
                userRoles[user.Id] = roles;
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = "Error", Detail = $"Error loading users: {ex.Message}" });
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task ToggleRegistration(ChangeEventArgs e)
    {
        allowUserRegistration = e.Value is bool b && b;
        if (_settings is not null)
        {
            _settings.AllowUserRegistration = allowUserRegistration;
            await _uow.ISettingsRepo.WriteSettings(_settings);
            await AddLog(allowUserRegistration ? "Registration enabled" : "Registration disabled");
            NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Success, Summary = "Success", Detail = allowUserRegistration ? "Registration enabled" : "Registration disabled" });
        }
    }

    private async Task OnActionClick(RadzenSplitButtonItem item, ApplicationUser user)
    {
        if ((string)item.Value == "edit")
        {
            await OpenEditDialog(user);
        }
        else if ((string)item.Value == "delete")
        {
            await DeleteUser(user);
        }
    }

    private async Task OpenEditDialog(ApplicationUser user)
    {
        var result = await DialogService.OpenAsync<UserEditDialog>("Edit User",
               new Dictionary<string, object>() { { "user", user }, { "currentRoles", userRoles[user.Id] } },
               new DialogOptions() { Width = "500px", Height = "auto", Resizable = true, Draggable = true });

        if (result == true)
        {
            await LoadUsers();
            NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Success, Summary = "Success", Detail = "User updated successfully" });
        }
    }

    private async Task DeleteUser(ApplicationUser user)
    {
        if (IsCurrentUser(user))
        {
            NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = "Error", Detail = "You cannot delete your own user account." });
            return;
        }

        if (userRoles[user.Id].Contains("superadmin") && !isSuperAdmin)
        {
            NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = "Error", Detail = "You cannot delete a super administrator." });
            return;
        }

        var confirmed = await DialogService.Confirm($"Are you sure you want to delete user '{user.UserName}'?", "Delete User", new ConfirmOptions() { OkButtonText = "Yes", CancelButtonText = "No" });
        if (confirmed == true)
        {
            var result = await UserManager.DeleteAsync(user);
            if (result.Succeeded)
            {
                users.Remove(user);
                userRoles.Remove(user.Id);
                StateHasChanged();
                await AddLog("User deleted", $"user: {user.UserName}, {user.FirstName}, {user.LastName}, {user.Email}");
                NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Success, Summary = "Success", Detail = "User deleted successfully" });
            }
            else
            {
                NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = "Error", Detail = $"Failed to delete user: {string.Join(", ", result.Errors.Select(e => e.Description))}" });
            }
        }
    }

    private bool IsUserActive(ApplicationUser user)
    {
        if (!user.LockoutEnabled)
            return true;

        if (user.LockoutEnd == null)
            return true;

        return user.LockoutEnd <= DateTimeOffset.UtcNow;
    }

    private bool IsCurrentUser(ApplicationUser user)
    {
        return string.Equals(user.UserName, currentUserName, StringComparison.OrdinalIgnoreCase);
    }

    private async Task AddLog(string action, string? details = null)
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        var username = user.Identity?.Name ?? "Unknown";

        var log = new LogEntry
        {
            Action = action,
            PerformedBy = username,
            Timestamp = DateTime.UtcNow,
            Details = details
        };

        Db.Logs.Add(log);
        await Db.SaveChangesAsync();
    }
}
