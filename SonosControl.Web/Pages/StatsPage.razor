@page "/stats"
@using SonosControl.Web.Data
@using SonosControl.Web.Models
@using Microsoft.EntityFrameworkCore
@attribute [Authorize(Roles = "admin,operator,superadmin")]
@inject ApplicationDbContext Db

<PageTitle>Statistics - Sonos Control</PageTitle>

<div class="container dashboard-shell">
    <div class="d-flex align-items-center justify-content-between mb-4">
        <div>
            <h3 class="mb-1">üìä Statistics</h3>
            <p class="text-muted mb-0">Usage insights and playback history.</p>
        </div>
    </div>

    <!-- User Hall of Fame -->
    <div class="row g-4 mb-4">
        <!-- Top DJ -->
        <div class="col-md-6 col-lg-3">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-body">
                     <h5 class="card-title mb-3">üéß Top DJ</h5>
                     <p class="card-subtitle mb-3 text-muted small">Most selections & playback starts</p>
                     @RenderLeaderboard(topDjStats, "actions")
                </div>
            </div>
        </div>

        <!-- The Skipper -->
        <div class="col-md-6 col-lg-3">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-body">
                     <h5 class="card-title mb-3">‚è≠Ô∏è The Skipper</h5>
                     <p class="card-subtitle mb-3 text-muted small">Most tracks skipped</p>
                     @RenderLeaderboard(skipperStats, "skips")
                </div>
            </div>
        </div>

        <!-- The Grouper -->
        <div class="col-md-6 col-lg-3">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-body">
                     <h5 class="card-title mb-3">üîó The Grouper</h5>
                     <p class="card-subtitle mb-3 text-muted small">Most groups & syncs created</p>
                     @RenderLeaderboard(grouperStats, "groups")
                </div>
            </div>
        </div>

        <!-- Night Owl -->
        <div class="col-md-6 col-lg-3">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-body">
                     <h5 class="card-title mb-3">ü¶â Night Owl</h5>
                     <p class="card-subtitle mb-3 text-muted small">Most active 10PM - 4AM</p>
                     @RenderLeaderboard(nightOwlStats, "actions")
                </div>
            </div>
        </div>
    </div>

    <!-- Activity Trends -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-body">
                    <h5 class="card-title mb-3">üìà Activity Trends (Last 30 Days)</h5>
                    @if (activityOverTime == null)
                    {
                        <p>Loading...</p>
                    }
                    else if (!activityOverTime.Any())
                    {
                        <p class="text-muted">No activity data available.</p>
                    }
                    else
                    {
                        <RadzenChart>
                            <RadzenLineSeries Data="@activityOverTime" CategoryProperty="Date" Title="Actions" ValueProperty="Count" LineType="LineType.Solid" Smooth="true">
                                <RadzenMarkers MarkerType="MarkerType.Circle" />
                            </RadzenLineSeries>
                            <RadzenCategoryAxis Padding="20" FormatString="{0:MM/dd}" />
                            <RadzenValueAxis>
                                <RadzenGridLines Visible="true" />
                            </RadzenValueAxis>
                        </RadzenChart>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Usage & Media -->
    <div class="row g-4 mb-4">
        <!-- Peak Usage -->
        <div class="col-lg-6">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-body">
                    <h5 class="card-title mb-3">‚è∞ Peak Usage Times</h5>
                    @if (activityByHour == null)
                    {
                        <p>Loading...</p>
                    }
                    else if (!activityByHour.Any())
                    {
                        <p class="text-muted">No data available.</p>
                    }
                    else
                    {
                        <RadzenChart>
                            <RadzenColumnSeries Data="@activityByHour" CategoryProperty="Hour" ValueProperty="Count" Title="Actions" />
                             <RadzenCategoryAxis Step="1" />
                        </RadzenChart>
                    }
                </div>
            </div>
        </div>

        <!-- Media Consumption -->
        <div class="col-lg-6">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-body">
                    <h5 class="card-title mb-3">ü•ß Media Consumption</h5>
                    @if (mediaTypeStats == null)
                    {
                        <p>Loading...</p>
                    }
                    else if (!mediaTypeStats.Any())
                    {
                        <p class="text-muted">No data available.</p>
                    }
                    else
                    {
                        <RadzenChart>
                            <RadzenDonutSeries Data="@mediaTypeStats" CategoryProperty="MediaType" ValueProperty="Duration" Title="Duration">
                                <RadzenSeriesDataLabels Visible="true" />
                            </RadzenDonutSeries>
                        </RadzenChart>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
         <!-- Top Stations -->
        <div class="col-lg-6">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-body">
                    <h5 class="card-title mb-3">üìª Top Stations (by Time)</h5>
                     @if (stationStats == null)
                     {
                         <p>Loading...</p>
                     }
                     else if (!stationStats.Any())
                     {
                         <p class="text-muted">No data available.</p>
                     }
                     else
                     {
                         <RadzenChart>
                             <RadzenColumnSeries Data="@stationStats" CategoryProperty="Station" ValueProperty="DurationHours" Title="Hours Played" LineType="LineType.Dashed" />
                             <RadzenColumnOptions Radius="5" />
                             <RadzenValueAxis Formatter="@FormatTimeAxis" />
                         </RadzenChart>
                     }
                </div>
            </div>
        </div>

        <!-- Top Tracks -->
        <div class="col-lg-6">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <h5 class="card-title mb-3">üéµ Top Tracks</h5>
                     @if (trackStats == null)
                     {
                         <p>Loading...</p>
                     }
                     else if (!trackStats.Any())
                     {
                         <p class="text-muted">No data available.</p>
                     }
                     else
                     {
                         <div class="table-responsive">
                             <table class="table table-hover align-middle">
                                 <thead>
                                     <tr>
                                         <th>Track</th>
                                         <th>Artist</th>
                                         <th>Total Time</th>
                                         <th>Play Count</th>
                                     </tr>
                                 </thead>
                                 <tbody>
                                     @foreach (var track in trackStats)
                                     {
                                         <tr>
                                             <td class="fw-bold">@track.Track</td>
                                             <td>@track.Artist</td>
                                             <td>@FormatDuration(track.Duration)</td>
                                             <td>@track.PlayCount</td>
                                         </tr>
                                     }
                                 </tbody>
                             </table>
                         </div>
                     }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    RenderFragment RenderLeaderboard(List<UserStat>? stats, string label) => __builder =>
    {
        if (stats == null)
        {
            <p>Loading...</p>
        }
        else if (!stats.Any())
        {
            <p class="text-muted">No data available.</p>
        }
        else
        {
            <ul class="list-group list-group-flush">
                @foreach (var user in stats)
                {
                    <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                        <span>
                            <span class="fw-bold">@user.User</span>
                        </span>
                        <span class="badge bg-primary rounded-pill">@user.Count @label</span>
                    </li>
                }
            </ul>
        }
    };

    class UserStat
    {
        public string User { get; set; } = "";
        public int Count { get; set; }
    }

    class StationStat
    {
        public string Station { get; set; } = "";
        public double Duration { get; set; }
        public double DurationHours => Math.Round(Duration / 3600.0, 2);
    }

    class TrackStat
    {
        public string Track { get; set; } = "";
        public string Artist { get; set; } = "";
        public double Duration { get; set; }
        public int PlayCount { get; set; }
    }

    class DateStat
    {
        public DateTime Date { get; set; }
        public int Count { get; set; }
    }

    class HourStat
    {
        public int Hour { get; set; }
        public int Count { get; set; }
    }

    class MediaStat
    {
        public string MediaType { get; set; } = "";
        public double Duration { get; set; }
    }

    private List<UserStat>? topDjStats;
    private List<UserStat>? skipperStats;
    private List<UserStat>? grouperStats;
    private List<UserStat>? nightOwlStats;

    private List<DateStat>? activityOverTime;
    private List<HourStat>? activityByHour;
    private List<MediaStat>? mediaTypeStats;

    private List<StationStat>? stationStats;
    private List<TrackStat>? trackStats;

    protected override async Task OnInitializedAsync()
    {
        await LoadStats();
    }

    private async Task LoadStats()
    {
        // Limit logs to last 30 days for user stats to keep it relevant
        var thirtyDaysAgo = DateTime.UtcNow.AddDays(-30);

        // 1. Top DJ: Selections & Playback Starts
        var djActions = new[]
        {
            "Station Changed",
            "Spotify Track Changed",
            "YouTube Music Changed",
            "Spotify URL Played",
            "Playback Started"
        };

        topDjStats = await Db.Logs
            .Where(l => l.Timestamp >= thirtyDaysAgo)
            .Where(l => djActions.Contains(l.Action))
            .GroupBy(l => l.PerformedBy)
            .Select(g => new UserStat { User = g.Key ?? "Unknown", Count = g.Count() })
            .OrderByDescending(x => x.Count)
            .Take(5)
            .ToListAsync();

        // 2. The Skipper: Next Track
        skipperStats = await Db.Logs
            .Where(l => l.Timestamp >= thirtyDaysAgo)
            .Where(l => l.Action == "Next Track")
            .GroupBy(l => l.PerformedBy)
            .Select(g => new UserStat { User = g.Key ?? "Unknown", Count = g.Count() })
            .OrderByDescending(x => x.Count)
            .Take(5)
            .ToListAsync();

        // 3. The Grouper: Group Created, Sync Play
        var groupActions = new[]
        {
            "Group Created",
            "Sync Play Started (Cloned URI)"
        };

        grouperStats = await Db.Logs
            .Where(l => l.Timestamp >= thirtyDaysAgo)
            .Where(l => groupActions.Contains(l.Action))
            .GroupBy(l => l.PerformedBy)
            .Select(g => new UserStat { User = g.Key ?? "Unknown", Count = g.Count() })
            .OrderByDescending(x => x.Count)
            .Take(5)
            .ToListAsync();

        // 4. Night Owl: 10PM - 4AM UTC (Approx Late Night)
        nightOwlStats = await Db.Logs
            .Where(l => l.Timestamp >= thirtyDaysAgo)
            .Where(l => l.Timestamp.Hour >= 22 || l.Timestamp.Hour < 4)
            .GroupBy(l => l.PerformedBy)
            .Select(g => new UserStat { User = g.Key ?? "Unknown", Count = g.Count() })
            .OrderByDescending(x => x.Count)
            .Take(5)
            .ToListAsync();

        // Activity Trends
        // Note: For SQLite, Timestamp.Date might require client eval in some EF versions, but usually works in recent ones.
        // If it fails, we can pull data and group in memory. Trying server-side first.
        var logsForTrends = await Db.Logs
            .Where(l => l.Timestamp >= thirtyDaysAgo)
            .ToListAsync(); // Pulling into memory to ensure GroupBy Date works safely across all providers including SQLite

        activityOverTime = logsForTrends
            .GroupBy(l => l.Timestamp.Date)
            .Select(g => new DateStat { Date = g.Key, Count = g.Count() })
            .OrderBy(x => x.Date)
            .ToList();

        // Peak Usage Times (Hour of Day)
        // Reusing logsForTrends since we already have them in memory for the same period
        activityByHour = logsForTrends
            .GroupBy(l => l.Timestamp.Hour)
            .Select(g => new HourStat { Hour = g.Key, Count = g.Count() })
            .OrderBy(x => x.Hour)
            .ToList();

        // Media Consumption
        mediaTypeStats = await Db.PlaybackStats
            .GroupBy(p => p.MediaType)
            .Select(g => new MediaStat { MediaType = g.Key, Duration = g.Sum(x => x.DurationSeconds) })
            .OrderByDescending(x => x.Duration)
            .ToListAsync();

        // Top Stations
        stationStats = await Db.PlaybackStats
            .Where(p => p.MediaType == "Station" || p.MediaType == "Stream")
            .GroupBy(p => p.TrackName)
            .Select(g => new StationStat { Station = g.Key, Duration = g.Sum(x => x.DurationSeconds) })
            .OrderByDescending(x => x.Duration)
            .Take(10)
            .ToListAsync();

        // Top Tracks
        trackStats = await Db.PlaybackStats
            .Where(p => p.MediaType != "Station" && p.MediaType != "Stream" && p.MediaType != "Unknown")
            .GroupBy(p => new { p.TrackName, p.Artist })
            .Select(g => new TrackStat
            {
                Track = g.Key.TrackName,
                Artist = g.Key.Artist,
                Duration = g.Sum(x => x.DurationSeconds),
                PlayCount = g.Count()
            })
            .OrderByDescending(x => x.Duration)
            .Take(20)
            .ToListAsync();
    }

    private string FormatDuration(double seconds)
    {
        var ts = TimeSpan.FromSeconds(seconds);
        if (ts.TotalHours >= 1)
            return $"{(int)ts.TotalHours}h {ts.Minutes}m";
        return $"{ts.Minutes}m {ts.Seconds}s";
    }

    string FormatTimeAxis(object value)
    {
        return $"{value}h";
    }
}
