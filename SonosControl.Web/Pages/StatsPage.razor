@page "/stats"
@using SonosControl.Web.Data
@using SonosControl.Web.Models
@using SonosControl.Web.Services
@using Microsoft.EntityFrameworkCore
@attribute [Authorize(Roles = "admin,operator,superadmin")]
@inject ApplicationDbContext Db

<PageTitle>Statistics - Sonos Control</PageTitle>

<div class="container dashboard-shell stats-shell">
    <div class="d-flex flex-wrap align-items-center justify-content-between mb-4 gap-3">
        <div>
            <h3 class="mb-1">üìä Statistics</h3>
            <p class="text-muted mb-0">Usage insights and playback history.</p>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="row g-4 mb-4">
        <div class="col-md-4">
            <div class="card h-100 shadow-sm border-0 bg-primary text-white">
                <div class="card-body text-center">
                    <h5 class="card-title mb-0">Total Listening Time</h5>
                    <h2 class="display-6 fw-bold my-2">@FormatDuration(totalDuration)</h2>
                    <p class="mb-0 small opacity-75">Last 30 Days</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100 shadow-sm border-0 bg-success text-white">
                <div class="card-body text-center">
                    <h5 class="card-title mb-0">Longest Session</h5>
                    <h2 class="display-6 fw-bold my-2">@(longestSession != null ? FormatDuration(longestSession.DurationSeconds) : "-")</h2>
                    <p class="mb-0 small opacity-75">@(longestSession?.TrackName ?? "None")</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100 shadow-sm border-0 bg-info text-white">
                <div class="card-body text-center">
                    <h5 class="card-title mb-0">Most Active Day</h5>
                    <h2 class="display-6 fw-bold my-2">@mostActiveDay</h2>
                    <p class="mb-0 small opacity-75">Based on activity</p>
                </div>
            </div>
        </div>

    </div>

    <!-- Hall of Fame & Leaderboards -->
    <div class="row g-4 mb-4">
        <!-- Station Master -->
        <div class="col-md-6 col-lg-3">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-body">
                     <h5 class="card-title mb-3">üìª Station Master</h5>
                     <p class="card-subtitle mb-3 text-muted small">Most station changes</p>
                     @RenderLeaderboard(stationMasterStats, "changes")
                </div>
            </div>
        </div>

        <!-- Top Stations (Plays) -->
        <div class="col-md-6 col-lg-3">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-body">
                     <h5 class="card-title mb-3">üìª Top Stations</h5>
                     <p class="card-subtitle mb-3 text-muted small">Most total plays</p>
                     @RenderLeaderboard(stationPlayCountStats, "plays")
                </div>
            </div>
        </div>

        <!-- The Silencer -->
        <div class="col-md-6 col-lg-3">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-body">
                     <h5 class="card-title mb-3">ü§´ The Silencer</h5>
                     <p class="card-subtitle mb-3 text-muted small">Most playback pauses</p>
                     @RenderLeaderboard(silencerStats, "pauses")
                </div>
            </div>
        </div>

        <!-- The Loner -->
        <div class="col-md-6 col-lg-3">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-body">
                     <h5 class="card-title mb-3">üíî The Loner</h5>
                     <p class="card-subtitle mb-3 text-muted small">Most groups disbanded</p>
                     @RenderLeaderboard(lonerStats, "ungroups")
                </div>
            </div>
        </div>
    </div>

    <!-- User Hall of Fame (Continued) -->
    <div class="row g-4 mb-4">
        <!-- Top DJ -->
        <div class="col-md-6 col-lg-3">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-body">
                     <h5 class="card-title mb-3">üéß Top DJ</h5>
                     <p class="card-subtitle mb-3 text-muted small">Most selections & playback starts</p>
                     @RenderLeaderboard(topDjStats, "actions")
                </div>
            </div>
        </div>

        <!-- The Skipper -->
        <div class="col-md-6 col-lg-3">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-body">
                     <h5 class="card-title mb-3">‚è≠Ô∏è The Skipper</h5>
                     <p class="card-subtitle mb-3 text-muted small">Most tracks skipped</p>
                     @RenderLeaderboard(skipperStats, "skips")
                </div>
            </div>
        </div>

        <!-- The Grouper -->
        <div class="col-md-6 col-lg-3">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-body">
                     <h5 class="card-title mb-3">üîó The Grouper</h5>
                     <p class="card-subtitle mb-3 text-muted small">Most groups & syncs created</p>
                     @RenderLeaderboard(grouperStats, "groups")
                </div>
            </div>
        </div>

        <!-- Night Owl -->
        <div class="col-md-6 col-lg-3">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-body">
                     <h5 class="card-title mb-3">ü¶â Night Owl</h5>
                     <p class="card-subtitle mb-3 text-muted small">Most active 10PM - 4AM</p>
                     @RenderLeaderboard(nightOwlStats, "actions")
                </div>
            </div>
        </div>
    </div>

    <!-- Activity Trends -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-body">
                    <h5 class="card-title mb-3">üìà Activity Trends (Last 30 Days)</h5>
                    @if (activityOverTime == null)
                    {
                        <p>Loading...</p>
                    }
                    else if (!activityOverTime.Any())
                    {
                        <p class="text-muted">No activity data available.</p>
                    }
                    else
                    {
                        <div class="stats-chart">
                            <RadzenChart>
                                <RadzenLineSeries Data="@activityOverTime" CategoryProperty="Date" Title="Actions" ValueProperty="Count" LineType="LineType.Solid" Smooth="true">
                                    <RadzenMarkers MarkerType="MarkerType.Circle" />
                                </RadzenLineSeries>
                                <RadzenCategoryAxis Padding="20" FormatString="{0:d}" />
                                <RadzenValueAxis>
                                    <RadzenGridLines Visible="true" />
                                </RadzenValueAxis>
                            </RadzenChart>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Usage & Media -->
    <div class="row g-4 mb-4">
        <!-- Peak Usage -->
        <div class="col-lg-6">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-body">
                    <h5 class="card-title mb-3">‚è∞ Peak Usage Times</h5>
                    @if (activityByHour == null)
                    {
                        <p>Loading...</p>
                    }
                    else if (!activityByHour.Any())
                    {
                        <p class="text-muted">No data available.</p>
                    }
                    else
                    {
                        <div class="stats-chart">
                            <RadzenChart>
                                <RadzenColumnSeries Data="@activityByHour" CategoryProperty="Hour" ValueProperty="Count" Title="Actions" />
                                 <RadzenCategoryAxis Step="1" />
                            </RadzenChart>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Media Consumption -->
        <div class="col-lg-6">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-body">
                    <h5 class="card-title mb-3">ü•ß Media Consumption</h5>
                    @if (mediaTypeStats == null)
                    {
                        <p>Loading...</p>
                    }
                    else if (!mediaTypeStats.Any())
                    {
                        <p class="text-muted">No data available.</p>
                    }
                    else
                    {
                        <div class="stats-chart">
                            <RadzenChart>
                                <RadzenDonutSeries Data="@mediaTypeStats" CategoryProperty="MediaType" ValueProperty="Duration" Title="Duration">
                                    <RadzenSeriesDataLabels Visible="true" />
                                </RadzenDonutSeries>
                            </RadzenChart>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
         <!-- Top Stations -->
        <div class="col-lg-6">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-body">
                    <h5 class="card-title mb-3">üìª Top Stations (by Time)</h5>
                     @if (stationStats == null)
                     {
                         <p>Loading...</p>
                     }
                     else if (!stationStats.Any())
                     {
                         <p class="text-muted">No data available.</p>
                     }
                     else
                     {
                         <div class="stats-chart">
                             <RadzenChart>
                                 <RadzenColumnSeries Data="@stationStats" CategoryProperty="Station" ValueProperty="DurationHours" Title="Hours Played" LineType="LineType.Dashed" />
                                 <RadzenColumnOptions Radius="5" />
                                 <RadzenValueAxis Formatter="@FormatTimeAxis" />
                             </RadzenChart>
                         </div>

                         <div class="table-responsive mt-3 stats-table-wrap">
                             <table class="table table-sm table-hover align-middle">
                                 <thead>
                                     <tr>
                                         <th>Station</th>
                                         <th>Time</th>
                                         <th>Plays</th>
                                     </tr>
                                 </thead>
                                 <tbody>
                                     @foreach (var station in stationStats)
                                     {
                                         <tr>
                                             <td class="small fw-bold">@station.Station</td>
                                             <td class="small">@FormatDuration(station.Duration)</td>
                                             <td class="small">@station.PlayCount</td>
                                         </tr>
                                     }
                                 </tbody>
                             </table>
                         </div>
                     }
                </div>
            </div>
        </div>

        <!-- Top Tracks -->
        <div class="col-lg-6">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <h5 class="card-title mb-3">üéµ Top Tracks</h5>
                     @if (trackStats == null)
                     {
                         <p>Loading...</p>
                     }
                     else if (!trackStats.Any())
                     {
                         <p class="text-muted">No data available.</p>
                     }
                     else
                     {
                         <div class="table-responsive stats-table-wrap">
                             <table class="table table-hover align-middle">
                                 <thead>
                                     <tr>
                                         <th>Track</th>
                                         <th>Artist</th>
                                         <th>Total Time</th>
                                         <th>Play Count</th>
                                     </tr>
                                 </thead>
                                 <tbody>
                                     @foreach (var track in trackStats)
                                     {
                                         <tr>
                                             <td class="fw-bold">@track.Track</td>
                                             <td>@track.Artist</td>
                                             <td>@FormatDuration(track.Duration)</td>
                                             <td>@track.PlayCount</td>
                                         </tr>
                                     }
                                 </tbody>
                             </table>
                         </div>
                     }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    RenderFragment RenderLeaderboard(List<UserStat>? stats, string label) => __builder =>
    {
        if (stats == null)
        {
            <p>Loading...</p>
        }
        else if (!stats.Any())
        {
            <p class="text-muted">No data available.</p>
        }
        else
        {
            <ul class="list-group list-group-flush">
                @foreach (var user in stats)
                {
                    <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                        <span>
                            <span class="fw-bold">@user.User</span>
                        </span>
                        <span class="badge bg-primary rounded-pill">@user.Count @label</span>
                    </li>
                }
            </ul>
        }
    };

    class UserStat
    {
        public string User { get; set; } = "";
        public int Count { get; set; }
    }

    class StationStat
    {
        public string Station { get; set; } = "";
        public double Duration { get; set; }
        public double DurationHours => Math.Round(Duration / 3600.0, 2);
        public int PlayCount { get; set; }
    }

    class TrackStat
    {
        public string Track { get; set; } = "";
        public string Artist { get; set; } = "";
        public double Duration { get; set; }
        public int PlayCount { get; set; }
    }

    class DateStat
    {
        public DateTime Date { get; set; }
        public int Count { get; set; }
    }

    class HourStat
    {
        public int Hour { get; set; }
        public int Count { get; set; }
    }

    class MediaStat
    {
        public string MediaType { get; set; } = "";
        public double Duration { get; set; }
    }

    class PlaybackAggregateRow
    {
        public string TrackName { get; set; } = "";
        public string Artist { get; set; } = "";
        public string MediaType { get; set; } = "";
        public double Duration { get; set; }
        public int PlayCount { get; set; }
    }

    private List<UserStat>? topDjStats;
    private List<UserStat>? skipperStats;
    private List<UserStat>? grouperStats;
    private List<UserStat>? nightOwlStats;
    private List<UserStat>? stationMasterStats;
    private List<UserStat>? stationPlayCountStats;
    private List<UserStat>? silencerStats;
    private List<UserStat>? lonerStats;

    private double totalDuration;
    private PlaybackHistory? longestSession;
    private string mostActiveDay = "-";

    private List<DateStat>? activityOverTime;
    private List<HourStat>? activityByHour;
    private List<MediaStat>? mediaTypeStats;

    private List<StationStat>? stationStats;
    private List<TrackStat>? trackStats;

    protected override async Task OnInitializedAsync()
    {
        await LoadStats();
    }

    private async Task LoadStats()
    {
        var thirtyDaysAgo = DateTime.UtcNow.AddDays(-30);
        var logsInWindow = Db.Logs.AsNoTracking().Where(l => l.Timestamp >= thirtyDaysAgo);
        var playbackInWindow = Db.PlaybackStats.AsNoTracking().Where(p => p.StartTime >= thirtyDaysAgo);
        var settingsRepo = _uow.ISettingsRepo;
        var settings = settingsRepo is null
            ? new SonosSettings()
            : await settingsRepo.GetSettings() ?? new SonosSettings();
        var resolver = RecommendationMediaResolver.Create(settings);

        var djActions = new[]
        {
            "Station Changed",
            "Spotify Track Changed",
            "YouTube Music Changed",
            "Spotify URL Played",
            "Playback Started"
        };

        topDjStats = await logsInWindow
            .Where(l => djActions.Contains(l.Action))
            .GroupBy(l => l.PerformedBy)
            .Select(g => new UserStat { User = g.Key ?? "Unknown", Count = g.Count() })
            .OrderByDescending(x => x.Count)
            .Take(5)
            .ToListAsync();

        skipperStats = await logsInWindow
            .Where(l => l.Action == "Next Track")
            .GroupBy(l => l.PerformedBy)
            .Select(g => new UserStat { User = g.Key ?? "Unknown", Count = g.Count() })
            .OrderByDescending(x => x.Count)
            .Take(5)
            .ToListAsync();

        var groupActions = new[]
        {
            "Group Created",
            "Sync Play Started (Cloned URI)"
        };

        grouperStats = await logsInWindow
            .Where(l => groupActions.Contains(l.Action))
            .GroupBy(l => l.PerformedBy)
            .Select(g => new UserStat { User = g.Key ?? "Unknown", Count = g.Count() })
            .OrderByDescending(x => x.Count)
            .Take(5)
            .ToListAsync();

        nightOwlStats = await logsInWindow
            .Where(l => l.Timestamp.Hour >= 22 || l.Timestamp.Hour < 4)
            .GroupBy(l => l.PerformedBy)
            .Select(g => new UserStat { User = g.Key ?? "Unknown", Count = g.Count() })
            .OrderByDescending(x => x.Count)
            .Take(5)
            .ToListAsync();

        stationMasterStats = await logsInWindow
            .Where(l => l.Action == "Station Changed")
            .GroupBy(l => l.PerformedBy)
            .Select(g => new UserStat { User = g.Key ?? "Unknown", Count = g.Count() })
            .OrderByDescending(x => x.Count)
            .Take(5)
            .ToListAsync();

        silencerStats = await logsInWindow
            .Where(l => l.Action == "Playback Paused")
            .GroupBy(l => l.PerformedBy)
            .Select(g => new UserStat { User = g.Key ?? "Unknown", Count = g.Count() })
            .OrderByDescending(x => x.Count)
            .Take(5)
            .ToListAsync();

        lonerStats = await logsInWindow
            .Where(l => l.Action == "Speaker Ungrouped")
            .GroupBy(l => l.PerformedBy)
            .Select(g => new UserStat { User = g.Key ?? "Unknown", Count = g.Count() })
            .OrderByDescending(x => x.Count)
            .Take(5)
            .ToListAsync();
        await InvokeAsync(StateHasChanged);

        totalDuration = await playbackInWindow
            .SumAsync(x => x.DurationSeconds);

        longestSession = await playbackInWindow
            .OrderByDescending(x => x.DurationSeconds)
            .FirstOrDefaultAsync();
        await InvokeAsync(StateHasChanged);

        try
        {
            activityOverTime = await logsInWindow
                .GroupBy(l => l.Timestamp.Date)
                .Select(g => new DateStat { Date = g.Key, Count = g.Count() })
                .OrderBy(x => x.Date)
                .ToListAsync();
        }
        catch (InvalidOperationException)
        {
            var timestamps = await logsInWindow.Select(l => l.Timestamp).ToListAsync();
            activityOverTime = timestamps
                .GroupBy(ts => ts.Date)
                .Select(g => new DateStat { Date = g.Key, Count = g.Count() })
                .OrderBy(x => x.Date)
                .ToList();
        }

        var activeDayGroup = activityOverTime?
            .GroupBy(x => x.Date.DayOfWeek)
            .OrderByDescending(g => g.Sum(x => x.Count))
            .FirstOrDefault();
        mostActiveDay = activeDayGroup?.Key.ToString() ?? "-";

        activityByHour = await logsInWindow
            .GroupBy(l => l.Timestamp.Hour)
            .Select(g => new HourStat { Hour = g.Key, Count = g.Count() })
            .OrderBy(x => x.Hour)
            .ToListAsync();
        await InvokeAsync(StateHasChanged);

        mediaTypeStats = await playbackInWindow
            .GroupBy(p => p.MediaType)
            .Select(g => new MediaStat { MediaType = g.Key, Duration = g.Sum(x => x.DurationSeconds) })
            .OrderByDescending(x => x.Duration)
            .ToListAsync();

        var stationRows = await playbackInWindow
            .Where(p => p.MediaType == "Station" || p.MediaType == "Stream" || p.MediaType == "Track")
            .GroupBy(p => new { p.TrackName, p.Artist, p.MediaType })
            .Select(g => new PlaybackAggregateRow
            {
                TrackName = g.Key.TrackName,
                Artist = g.Key.Artist,
                MediaType = g.Key.MediaType,
                Duration = g.Sum(x => x.DurationSeconds),
                PlayCount = g.Count()
            })
            .ToListAsync();

        var normalizedStations = stationRows
            .Select(row => new
            {
                row.Duration,
                row.PlayCount,
                Resolved = resolver.ResolveFromPlaybackEntry(row.TrackName, row.Artist, row.MediaType)
            })
            .Where(x => string.Equals(x.Resolved.MediaType, "Station", StringComparison.OrdinalIgnoreCase))
            .Where(x => !string.IsNullOrWhiteSpace(x.Resolved.Name))
            .GroupBy(x => x.Resolved.Name)
            .Select(g => new StationStat
            {
                Station = g.Key,
                Duration = g.Sum(x => x.Duration),
                PlayCount = g.Sum(x => x.PlayCount)
            })
            .ToList();

        stationPlayCountStats = normalizedStations
            .OrderByDescending(x => x.PlayCount)
            .ThenByDescending(x => x.Duration)
            .ThenBy(x => x.Station)
            .Take(5)
            .Select(x => new UserStat { User = x.Station, Count = x.PlayCount })
            .ToList();

        stationStats = normalizedStations
            .OrderByDescending(x => x.Duration)
            .ThenByDescending(x => x.PlayCount)
            .ThenBy(x => x.Station)
            .Take(10)
            .ToList();

        var trackRows = await playbackInWindow
            .Where(p => p.MediaType != "Unknown")
            .GroupBy(p => new { p.TrackName, p.Artist, p.MediaType })
            .Select(g => new PlaybackAggregateRow
            {
                TrackName = g.Key.TrackName,
                Artist = g.Key.Artist,
                MediaType = g.Key.MediaType,
                Duration = g.Sum(x => x.DurationSeconds),
                PlayCount = g.Count()
            })
            .ToListAsync();

        trackStats = trackRows
            .Select(row => new
            {
                Row = row,
                Resolved = resolver.ResolveFromPlaybackEntry(row.TrackName, row.Artist, row.MediaType)
            })
            .Where(x => !string.Equals(x.Resolved.MediaType, "Station", StringComparison.OrdinalIgnoreCase))
            .Where(x => !string.IsNullOrWhiteSpace(x.Row.TrackName))
            .GroupBy(x => new { x.Row.TrackName, x.Row.Artist })
            .Select(g => new TrackStat
            {
                Track = g.Key.TrackName,
                Artist = g.Key.Artist,
                Duration = g.Sum(x => x.Row.Duration),
                PlayCount = g.Sum(x => x.Row.PlayCount)
            })
            .OrderByDescending(x => x.Duration)
            .ThenBy(x => x.Track)
            .Take(20)
            .ToList();
        await InvokeAsync(StateHasChanged);
    }

    private string FormatDuration(double seconds)
    {
        var ts = TimeSpan.FromSeconds(seconds);
        if (ts.TotalHours >= 1)
            return $"{(int)ts.TotalHours}h {ts.Minutes}m";
        return $"{ts.Minutes}m {ts.Seconds}s";
    }

    string FormatTimeAxis(object value)
    {
        return $"{value}h";
    }
}
