@page "/useredit"
@using System.ComponentModel.DataAnnotations
@inject AuthenticationStateProvider AuthenticationStateProvider
@using Microsoft.AspNetCore.Identity
@using SonosControl.Web.Models
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager NavigationManager

<PageTitle>Edit User</PageTitle>
<AuthorizeView Context="authContext">
    <Authorized>
        <div class="auth-shell">
            <section class="auth-card panel stack-sm user-edit-card" aria-labelledby="user-edit-heading">
                <h3 id="user-edit-heading" class="page-title text-center mb-3">📝 Edit User</h3>

                @if (user == null)
                {
                    <p class="text-muted text-center mb-0">Loading...</p>
                    @if (!string.IsNullOrEmpty(statusMessage))
                    {
                        <FormStatus StatusMessage="@statusMessage" Severity="@statusSeverity" />
                    }
                }
                else
                {
                    <EditForm Model="editModel" OnValidSubmit="HandleUpdate" class="stack-md">
                        <DataAnnotationsValidator />
                        <FormStatus StatusMessage="@statusMessage" Severity="@statusSeverity" />

                        <FormField Label="First Name" Id="edit-firstname">
                            <InputText id="edit-firstname" class="form-control" @bind-Value="editModel.FirstName" />
                        </FormField>

                        <FormField Label="Last Name" Id="edit-lastname">
                            <InputText id="edit-lastname" class="form-control" @bind-Value="editModel.LastName" />
                        </FormField>

                        <FormField Label="Email" Id="edit-email">
                            <InputText id="edit-email" type="email" class="form-control" @bind-Value="editModel.Email" />
                        </FormField>

                        <FormField Label="Username" Id="edit-username">
                            <InputText id="edit-username" class="form-control" disabled @bind-Value="editModel.UserName" />
                        </FormField>

                        <FormField Label="New Password (optional)" Id="edit-new-password">
                            <InputText id="edit-new-password" type="password" class="form-control" @bind-Value="editModel.NewPassword" />
                        </FormField>

                        <FormField Label="Confirm Password (optional)" Id="edit-confirm-password">
                            <InputText id="edit-confirm-password" type="password" class="form-control" @bind-Value="editModel.ConfirmPassword" />
                        </FormField>

                        <div class="stack-sm">
                            <button type="submit" class="btn btn-primary w-100">Update</button>
                            <button type="button" class="btn btn-outline-secondary w-100" @onclick="Cancel">Cancel</button>
                        </div>
                    </EditForm>
                }
            </section>
        </div>
    </Authorized>
    <NotAuthorized>
        <div class="alert alert-warning">
            You must be logged in to view this page.
        </div>
    </NotAuthorized>
</AuthorizeView>

@code {
    public string? UserId { get; set; }

    private ApplicationUser? user;
    private EditUserModel editModel = new();
    private string? statusMessage;
    private FormStatus.AlertSeverity statusSeverity = FormStatus.AlertSeverity.Info;
    private bool isAuthenticated;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user_auth = authState.User;

        isAuthenticated = user_auth.Identity?.IsAuthenticated ?? false;

        if (isAuthenticated)
        {
            var appUser = await UserManager.GetUserAsync(user_auth);
            UserId = appUser?.Id;
        }
        
        user = await UserManager.FindByIdAsync(UserId);

        if (user != null)
        {
            editModel = new EditUserModel
            {
                FirstName = user.FirstName,
                LastName = user.LastName,
                Email = user.Email,
                UserName = user.UserName
            };
        }
        else
        {
            SetStatus("User not found.", FormStatus.AlertSeverity.Danger);
        }
    }

    private async Task HandleUpdate()
    {
        if (user == null)
        {
            SetStatus("User not loaded.", FormStatus.AlertSeverity.Danger);
            return;
        }

        user.FirstName = editModel.FirstName;
        user.LastName = editModel.LastName;
        user.Email = editModel.Email;

        if (!string.IsNullOrWhiteSpace(editModel.NewPassword) && editModel.NewPassword != editModel.ConfirmPassword)
        {
            SetStatus("Passwords do not match.", FormStatus.AlertSeverity.Danger);
            return;
        }

        var updateResult = await UserManager.UpdateAsync(user);

        if (!updateResult.Succeeded)
        {
            SetStatus("Error updating user: " + string.Join(", ", updateResult.Errors.Select(e => e.Description)), FormStatus.AlertSeverity.Danger);
            return;
        }

        if (!string.IsNullOrWhiteSpace(editModel.NewPassword))
        {
            var token = await UserManager.GeneratePasswordResetTokenAsync(user);
            var passResult = await UserManager.ResetPasswordAsync(user, token, editModel.NewPassword);

            if (!passResult.Succeeded)
            {
                SetStatus("Password reset failed: " + string.Join(", ", passResult.Errors.Select(e => e.Description)), FormStatus.AlertSeverity.Danger);
                return;
            }
        }

        SetStatus("✅ User updated successfully.", FormStatus.AlertSeverity.Success);
    }

    private void Cancel()
    {
        NavigationManager.NavigateTo("/");
    }

    private void SetStatus(string message, FormStatus.AlertSeverity severity)
    {
        statusMessage = message;
        statusSeverity = severity;
    }

    public class EditUserModel
    {
        [Required] public string FirstName { get; set; } = string.Empty;
        [Required] public string LastName { get; set; } = string.Empty;
        [Required, EmailAddress] public string Email { get; set; } = string.Empty;
        [Required] public string UserName { get; set; } = string.Empty;
        
        [StringLength(100, MinimumLength = 6, ErrorMessage = "Password must be at least 6 characters.")]
        public string? NewPassword { get; set; }

        [Compare(nameof(NewPassword), ErrorMessage = "Passwords do not match.")]
        public string? ConfirmPassword { get; set; }
    }
}

