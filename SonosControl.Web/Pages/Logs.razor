@page "/logs"
@using SonosControl.Web.Models
@inject AuthenticationStateProvider AuthenticationStateProvider
@using SonosControl.Web.Data
@using Microsoft.EntityFrameworkCore
@inject ApplicationDbContext Db
@implements IDisposable
@attribute [Authorize(Roles = "admin,operator,superadmin")]

<PageTitle>System Logs</PageTitle>

<section class="logs-shell card surface-1 shadow-sm border border-1">
    <div class="card-body p-4 p-lg-5">
        <header class="logs-header d-flex flex-column flex-md-row align-items-start justify-content-between gap-3 mb-4">
            <div>
                <h2 class="page-title mb-1">📜 System Logs</h2>
                <p class="text-muted mb-0">A chronological overview of operator activity.</p>
            </div>
            <div class="toolbar-actions logs-toolbar align-items-center flex-wrap d-none d-md-flex">
                <div class="logs-toolbar__group d-flex align-items-center gap-2">
                    <label for="logSearch" class="form-label logs-toolbar__label mb-0 visually-hidden">Search</label>
                    <input id="logSearch"
                           type="text"
                           class="form-control form-control-sm"
                           placeholder="Search..."
                           @bind="searchTerm"
                           @bind:event="oninput"/>
                </div>
                <div class="logs-toolbar__group d-flex align-items-center gap-2">
                    <label for="userFilter" class="form-label logs-toolbar__label mb-0 visually-hidden">User</label>
                    <select id="userFilter" class="form-select form-select-sm" @bind="selectedUser">
                        <option value="">All Users</option>
                        @foreach (var user in allUsers)
                        {
                            <option value="@user">@(user ?? "System")</option>
                        }
                    </select>
                </div>
                <div class="logs-toolbar__group d-flex align-items-center gap-2">
                    <label for="startDate" class="form-label logs-toolbar__label mb-0">From</label>
                    <input id="startDate" type="date" class="form-control form-control-sm" @bind="startDate"/>
                </div>
                <div class="logs-toolbar__group d-flex align-items-center gap-2">
                    <label for="endDate" class="form-label logs-toolbar__label mb-0">To</label>
                    <input id="endDate" type="date" class="form-control form-control-sm" @bind="endDate"/>
                </div>
                <div class="logs-toolbar__group d-flex align-items-center gap-2">
                    <button class="btn btn-sm btn-outline-secondary" @onclick="ClearFilters">Clear</button>
                </div>
                <div class="logs-toolbar__group d-flex align-items-center gap-2">
                    <label for="logCountSelect" class="form-label logs-toolbar__label mb-0">Show</label>
                    <select id="logCountSelect"
                            class="form-select form-select-sm logs-count-select"
                            @bind="selectedLogCount">
                        <option value="50">50</option>
                        <option value="100">100</option>
                        <option value="500">500</option>
                        <option value="1000">1000</option>
                        <option value="-1">Custom</option>
                    </select>
                </div>
                @if (selectedLogCount == -1)
                {
                    <div class="logs-toolbar__group d-flex align-items-center gap-2">
                        <label for="customLogCount" class="form-label logs-toolbar__label mb-0">Count</label>
                        <input id="customLogCount"
                               type="number"
                               min="1"
                               class="form-control form-control-sm logs-count-input"
                               placeholder="Enter number"
                               @bind="customLogCount"
                               @bind:event="onchange"/>
                    </div>
                }
            </div>

            <div class="logs-toolbar-mobile d-md-none w-100">
                <div class="logs-toolbar__group d-flex align-items-center gap-2 w-100 mb-2">
                    <label for="logSearchMobile" class="form-label logs-toolbar__label mb-0 visually-hidden">Search</label>
                    <input id="logSearchMobile"
                           type="text"
                           class="form-control form-control-sm"
                           placeholder="Search logs..."
                           @bind="searchTerm"
                           @bind:event="oninput" />
                </div>

                <details class="logs-filter-panel">
                    <summary class="logs-filter-panel__summary">Advanced filters</summary>
                    <div class="logs-filter-panel__body">
                        <div class="logs-toolbar__group d-flex align-items-center gap-2">
                            <label for="userFilterMobile" class="form-label logs-toolbar__label mb-0 visually-hidden">User</label>
                            <select id="userFilterMobile" class="form-select form-select-sm" @bind="selectedUser">
                                <option value="">All Users</option>
                                @foreach (var user in allUsers)
                                {
                                    <option value="@user">@(user ?? "System")</option>
                                }
                            </select>
                        </div>

                        <div class="logs-toolbar__group d-flex align-items-center gap-2">
                            <label for="startDateMobile" class="form-label logs-toolbar__label mb-0">From</label>
                            <input id="startDateMobile" type="date" class="form-control form-control-sm" @bind="startDate" />
                        </div>

                        <div class="logs-toolbar__group d-flex align-items-center gap-2">
                            <label for="endDateMobile" class="form-label logs-toolbar__label mb-0">To</label>
                            <input id="endDateMobile" type="date" class="form-control form-control-sm" @bind="endDate" />
                        </div>

                        <div class="logs-toolbar__group d-flex align-items-center gap-2">
                            <label for="logCountSelectMobile" class="form-label logs-toolbar__label mb-0">Show</label>
                            <select id="logCountSelectMobile"
                                    class="form-select form-select-sm logs-count-select"
                                    @bind="selectedLogCount">
                                <option value="50">50</option>
                                <option value="100">100</option>
                                <option value="500">500</option>
                                <option value="1000">1000</option>
                                <option value="-1">Custom</option>
                            </select>
                        </div>

                        @if (selectedLogCount == -1)
                        {
                            <div class="logs-toolbar__group d-flex align-items-center gap-2">
                                <label for="customLogCountMobile" class="form-label logs-toolbar__label mb-0">Count</label>
                                <input id="customLogCountMobile"
                                       type="number"
                                       min="1"
                                       class="form-control form-control-sm logs-count-input"
                                       placeholder="Enter number"
                                       @bind="customLogCount"
                                       @bind:event="onchange" />
                            </div>
                        }

                        <div class="logs-toolbar__group d-flex align-items-center gap-2">
                            <button class="btn btn-sm btn-outline-secondary w-100" @onclick="ClearFilters">Clear filters</button>
                        </div>
                    </div>
                </details>
            </div>
        </header>

        @if (logs == null)
        {
            <div class="alert alert-info logs-status-alert" role="status" aria-live="polite">
                <span class="fw-semibold">Loading logs…</span>
            </div>
        }
        else if (!logs.Any())
        {
            <div class="alert alert-warning logs-status-alert" role="status" aria-live="polite">
                <span>No log entries were found.</span>
            </div>
        }
        else
        {
            <div class="logs-table-wrapper d-none d-md-block">
                <table class="table table-striped table-hover align-middle logs-table mb-0">
                    <thead>
                        <tr>
                            <th scope="col">Date</th>
                            <th scope="col">User</th>
                            <th scope="col" class="d-none d-sm-table-cell">Action</th>
                            <th scope="col" class="d-none d-md-table-cell">Details</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var log in logs)
                        {
                            <tr @key="log.Id">
                                <td>@log.Timestamp.ToLocalTime().ToString("g")</td>
                                <td>@(string.IsNullOrWhiteSpace(log.PerformedBy) ? "System" : log.PerformedBy)</td>
                                <td class="d-none d-sm-table-cell">@log.Action</td>
                                <td class="d-none d-md-table-cell">@(!string.IsNullOrWhiteSpace(log.Details) ? log.Details : "—")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <div class="logs-card-list d-grid d-md-none">
                @foreach (var log in logs)
                {
                    <article class="logs-card" @key="log.Id">
                        <div class="logs-card__meta">
                            <span>@log.Timestamp.ToLocalTime().ToString("g")</span>
                            <span class="badge bg-secondary text-uppercase fs-7">
                                @(string.IsNullOrWhiteSpace(log.PerformedBy) ? "System" : log.PerformedBy)
                            </span>
                        </div>
                        <p class="logs-card__action mb-1 fw-semibold">@log.Action</p>
                        <p class="logs-card__details mb-0 text-muted">@(!string.IsNullOrWhiteSpace(log.Details) ? log.Details : "—")</p>
                    </article>
                }
            </div>
        }
    </div>
</section>

@code {
    private List<LogEntry>? logs;
    private int _selectedLogCount = 100;

    private int selectedLogCount
    {
        get => _selectedLogCount;
        set
        {
            if (_selectedLogCount != value)
            {
                _selectedLogCount = value;
                _ = RefreshLogs();
            }
        }
    }

    private int _customLogCount = 200;

    private int customLogCount
    {
        get => _customLogCount;
        set
        {
            if (_customLogCount != value)
            {
                _customLogCount = value;
                _ = RefreshLogs();
            }
        }
    }

    private string? _searchTerm;

    private string? searchTerm
    {
        get => _searchTerm;
        set
        {
            if (_searchTerm != value)
            {
                _searchTerm = value;
                DebounceRefresh();
            }
        }
    }

    private string? _selectedUser;

    private string? selectedUser
    {
        get => _selectedUser;
        set
        {
            if (_selectedUser != value)
            {
                _selectedUser = value;
                _ = RefreshLogs();
            }
        }
    }

    private DateTime? _startDate;

    private DateTime? startDate
    {
        get => _startDate;
        set
        {
            if (_startDate != value)
            {
                _startDate = value;
                _ = RefreshLogs();
            }
        }
    }

    private DateTime? _endDate;

    private DateTime? endDate
    {
        get => _endDate;
        set
        {
            if (_endDate != value)
            {
                _endDate = value;
                _ = RefreshLogs();
            }
        }
    }

    private List<string?> allUsers = new();
    private CancellationTokenSource? _searchDebounceCts;
    private CancellationTokenSource? _refreshCts;

    protected override async Task OnInitializedAsync()
    {
        await LoadInitialData();
        await RefreshLogs();
    }

    private async Task LoadInitialData()
    {
        allUsers = await Db.Logs
            .AsNoTracking()
            .Select(l => l.PerformedBy)
            .Distinct()
            .OrderBy(u => u)
            .ToListAsync();
    }

    private async Task RefreshLogs()
    {
        CancellationTokenSource? previousCts = null;
        CancellationToken token;

        previousCts = _refreshCts;
        _refreshCts = new CancellationTokenSource();
        previousCts?.Cancel();
        token = _refreshCts.Token;

        int countToTake = selectedLogCount == -1 ? customLogCount : selectedLogCount;
        if (countToTake <= 0) countToTake = 100;

        var query = Db.Logs.AsNoTracking().AsQueryable();

        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            var trimmedSearch = searchTerm.Trim();
            query = query.Where(l =>
                l.Action.Contains(trimmedSearch) ||
                (l.PerformedBy != null && l.PerformedBy.Contains(trimmedSearch)) ||
                (l.Details != null && l.Details.Contains(trimmedSearch)));
        }

        if (!string.IsNullOrEmpty(selectedUser))
        {
            query = query.Where(l => l.PerformedBy == selectedUser);
        }

        if (startDate.HasValue)
        {
            var startInclusive = startDate.Value.Date;
            query = query.Where(l => l.Timestamp >= startInclusive);
        }

        if (endDate.HasValue)
        {
            var endExclusive = endDate.Value.Date.AddDays(1);
            query = query.Where(l => l.Timestamp < endExclusive);
        }

        try
        {
            logs = await query
                .OrderByDescending(l => l.Timestamp)
                .Take(countToTake)
                .ToListAsync(token);
        }
        catch (OperationCanceledException) when (token.IsCancellationRequested)
        {
            return;
        }
        finally
        {
            previousCts?.Dispose();
            await InvokeAsync(StateHasChanged);
        }
    }

    private void DebounceRefresh()
    {
        _searchDebounceCts?.Cancel();
        _searchDebounceCts?.Dispose();
        _searchDebounceCts = new CancellationTokenSource();
        _ = DebouncedRefreshAsync(_searchDebounceCts.Token);
    }

    private async Task DebouncedRefreshAsync(CancellationToken token)
    {
        try
        {
            await Task.Delay(300, token);
            await InvokeAsync(RefreshLogs);
        }
        catch (OperationCanceledException) when (token.IsCancellationRequested)
        {
        }
    }

    private async Task ClearFilters()
    {
        _searchTerm = null;
        _selectedUser = null;
        _startDate = null;
        _endDate = null;
        await RefreshLogs();
    }

    public void Dispose()
    {
        _searchDebounceCts?.Cancel();
        _searchDebounceCts?.Dispose();
        _refreshCts?.Cancel();
        _refreshCts?.Dispose();
    }

}
